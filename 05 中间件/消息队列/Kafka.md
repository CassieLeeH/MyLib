- [消息队列基本概念](#消息队列基本概念)
  - [什么是消息队列](#什么是消息队列)
  - [消息队列的功能](#消息队列的功能)
  - [消息队列与RPC](#消息队列与rpc)
  - [常见类型](#常见类型)
  - [消息队列设计](#消息队列设计)

## 消息队列基本概念

### 什么是消息队列

**异步通讯**的**中间件** : 存放消息的容器。当我们需要使用消息时，取出消息供我们使用。

消息是一种数据结构（当然，对象也可以看做是一种特殊的消息），它包含**消费者与生产者双方都能识别的数据**，这些数据**需要在不同的进程（机器）之间进行传递**，并可能会被多个完全不同的客户端消费。

生产者先将消息投递一个叫做「队列」的容器中，然后再从这个容器中取出消息，最后再转发给消费者，仅此而已。本质：**一发一存一消费**，可以视为一种转发器。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210503225704218.png)

### 消息队列的功能

分布式场景下，通过消息传递和消息排队模型，提供**系统解耦、异步通信和流量削峰**的功能。

**场景举例**：电商业务中最常见的「订单支付」场景：在订单支付成功后，需要更新订单状态、更新用户积分、通知商家有新订单、更新推荐系统中的用户画像等等。

**缺点：系统彼此依赖，耦合性比较高，消息只能同步逐层传递，如果订单比较多，系统的吞吐量就可能不足。**

此时引入消息队列：

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210504084517524.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzk1ODU1Ng==,size_16,color_FFFFFF,t_70)

引入 MQ 后，订单支付只需要关注它最重要的流程：更新订单状态即可。其他不重要的事情全部交给 MQ 来通知。这便是 MQ 解决的最核心的问题：**系统解耦**。

改造前订单系统依赖 3 个外部系统，改造后仅仅依赖 MQ，而且后续业务再扩展（比如：营销系统打算针对支付用户奖励优惠券），也不涉及订单系统的修改，从而保证了核心流程的稳定性，**降低了维护成本**。

这个改造还带来了另外一个好处：因为 MQ 的引入，更新用户积分、通知商家、更新用户画像这些步骤全部变成了**异步执行**，能减少订单支付的整体耗时，**提升订单系统的吞吐量**。这便是 MQ 的另一个典型应用场景：**异步通信**。

除此以外，由于**队列能转储消息，对于超出系统承载能力的场景，可以用 MQ 作为 “漏斗” 进行限流保护**，即所谓的**流量削峰**。

### 消息队列与RPC

从MQ 的通信模型来看，可以理解成：两次 RPC + 消息转储。

**1、**引入 MQ 后，由之前的一次 RPC 变成了现在的两次 RPC，而且生产者只跟队列耦合，它根本无需知道消费者的存在。
**2、**多了一个中间节点「队列」进行消息转储，相当于将同步变成了异步。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210504084404451.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzk1ODU1Ng==,size_16,color_FFFFFF,t_70)

### 常见类型

**点对点模型**



**发布/订阅模型**



### 消息队列设计

（待定，积累更多实际经验补充）

功能性需求：发消息、存消息、消费消息

非功能性需求：高性能、高可用、高扩展

![image-20220706092851467](C:\Users\l50025929\AppData\Roaming\Typora\typora-user-images\image-20220706092851467.png)
