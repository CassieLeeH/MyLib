# Javaè®¾è®¡æ¨¡å¼å­¦ä¹ 

- **æœ¬æ–‡ä½œè€…ï¼š** MrBird
- **æœ¬æ–‡é“¾æ¥ï¼š** http://mrbird.cc/Javaè®¾è®¡æ¨¡å¼.html
- **æœ¬æ–‡ä»…ä¸ºä¸ªäººå­¦ä¹ æ•´ç†è½¬è½½**

## åˆ›å»ºå‹æ¨¡å¼

### ç®€å•å·¥å‚æ¨¡å¼

ç®€å•å·¥å‚æ¨¡å¼ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ï¼Œå¹¶ä¸å±äºè®¾è®¡æ¨¡å¼ä¸­çš„ä¸€ç§ï¼Œä¸è¿‡è¿™é‡Œè¿˜æ˜¯ç®€å•è®°å½•ä¸‹ã€‚

**å®šä¹‰**ï¼šç”±ä¸€ä¸ªå·¥å‚å¯¹è±¡å†³å®šåˆ›å»ºå‡ºå“ªä¸€ç§ç±»å‹å®ä¾‹ã€‚å®¢æˆ·ç«¯åªéœ€ä¼ å…¥å·¥å‚ç±»çš„å‚æ•°ï¼Œæ— å¿ƒå…³å¿ƒåˆ›å»ºè¿‡ç¨‹ã€‚

**ä¼˜ç‚¹**ï¼šå…·ä½“äº§å“ä»å®¢æˆ·ç«¯ä»£ç ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œè§£è€¦ã€‚

**ç¼ºç‚¹**ï¼šå·¥å‚ç±»èŒè´£è¿‡é‡ï¼Œå¢åŠ æ–°çš„ç±»å‹æ—¶ï¼Œå¾—ä¿®æ”¹å·¥ç¨‹ç±»å¾—ä»£ç ï¼Œè¿èƒŒå¼€é—­åŸåˆ™ã€‚

ä¸¾ä¾‹ï¼šæ–°å»ºFruitæ°´æœæŠ½è±¡ç±»ï¼ŒåŒ…å«eatæŠ½è±¡æ–¹æ³•ï¼š

```
public abstract class Fruit {

    public abstract void eat();
}
```



å…¶å®ç°ç±»Appleï¼š

```
public class Apple extends Fruit{
    @Override
    public void eat() {
        System.out.println("åƒğŸ");
    }
}
```



æ–°å»ºåˆ›å»ºFruitçš„å·¥å‚ç±»ï¼š

```
public class FruitFactory {

    public Fruit produce(String name) {
        if ("apple".equals(name)) {
            return new Apple();
        } else {
            return null;
        }
    }
}
```



æ–°å»ºä¸ªå®¢æˆ·ç«¯æµ‹è¯•ä¸€ä¸‹ï¼š

```
public class Application {

    public static void main(String[] args) {
        FruitFactory factory = new FruitFactory();
        Fruit fruit = factory.produce("apple");
        fruit.eat();
    }
}
```



è¿è¡Œmainæ–¹æ³•ï¼Œè¾“å‡ºï¼š

```
åƒğŸ
```



å¯ä»¥çœ‹åˆ°ï¼Œå®¢æˆ·ç«¯Applicationå¹¶æœªä¾èµ–å…·ä½“çš„æ°´æœç±»å‹ï¼Œåªå…³å¿ƒFruitFactoryçš„å…¥å‚ï¼Œè¿™å°±æ˜¯å®¢æˆ·ç«¯å’Œå…·ä½“äº§å“è§£è€¦çš„ä½“ç°ï¼ŒUMLå›¾å¦‚ä¸‹ï¼š

![QQæˆªå›¾20191216103019.png](https://mrbird.cc/img/QQ%E6%88%AA%E5%9B%BE20191216103019.png)
### å·¥å‚æ–¹æ³•æ¨¡å¼

ä¸ºäº†è§£å†³ç®€å•å·¥å‚æ¨¡å¼çš„ç¼ºç‚¹ï¼Œè¯ç”Ÿäº†å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory method patternï¼‰ã€‚

**å®šä¹‰**ï¼šå®šä¹‰åˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å®ç°è¿™ä¸ªæ¥å£çš„ç±»æ¥å†³å®šå®ä¾‹åŒ–å“ªä¸ªç±»ï¼Œå·¥å‚æ–¹æ³•è®©ç±»çš„å®ä¾‹åŒ–æ¨è¿Ÿåˆ°äº†å­ç±»è¿›è¡Œã€‚

**ä¼˜ç‚¹**ï¼š

1. å…·ä½“äº§å“ä»å®¢æˆ·ç«¯ä»£ç ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œè§£è€¦ã€‚
2. åŠ å…¥æ–°çš„ç±»å‹æ—¶ï¼Œåªéœ€æ·»åŠ æ–°çš„å·¥å‚æ–¹æ³•ï¼ˆæ— éœ€ä¿®æ”¹æ—§çš„å·¥å‚æ–¹æ³•ä»£ç ï¼‰ï¼Œç¬¦åˆå¼€é—­åŸåˆ™ã€‚

**ç¼ºç‚¹**ï¼šç±»çš„ä¸ªæ•°å®¹æ˜“è¿‡å¤šï¼Œå¢åŠ å¤æ‚åº¦ã€‚

ä¸¾ä¾‹ï¼šæ–°å»ºFruitæŠ½è±¡ç±»ï¼ŒåŒ…å«eatæŠ½è±¡æ–¹æ³•ï¼š

```
public abstract class Fruit {

    public abstract void eat();
}
```



æ–°å»ºFruitFactoryæŠ½è±¡å·¥å‚ï¼Œå®šä¹‰produceFruitæŠ½è±¡æ–¹æ³•ï¼š

```
public abstract class FruitFactory {

    public abstract Fruit produceFruit();
}
```



æ–°å»ºFruitçš„å®ç°ç±»ï¼ŒAppleï¼š

```
public class Apple extends Fruit {
    @Override
    public void eat() {
        System.out.println("åƒğŸ");
    }
}
```



æ–°å»ºFruitFactoryçš„å®ç°ç±»AppleFruitFactoryï¼Œç”¨äºç”Ÿäº§å…·ä½“ç±»å‹çš„æ°´æœ â€”â€” è‹¹æœï¼š

```
public class AppleFruitFactory extends FruitFactory{
    @Override
    public Fruit produceFruit() {
        return new Apple();
    }
}
```



æ–°å»ºå®¢æˆ·ç«¯Applicationæµ‹è¯•ä¸€æ³¢ï¼š

```
public class Application {

    public static void main(String[] args) {
        FruitFactory factory = new AppleFruitFactory();
        Fruit fruit = factory.produceFruit();
        fruit.eat();
    }
}
```



è¿è¡Œmainæ–¹æ³•ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

```
åƒğŸ
```



ç°åœ¨è¦æ–°å¢Bananaç±»å‹çš„æ°´æœï¼Œåªéœ€è¦æ–°å¢Bananaç±»å‹çš„å·¥å‚ç±»å³å¯ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰çš„AppleFruitFactoryä»£ç ï¼Œç¬¦åˆå¼€é—­åŸåˆ™ã€‚ä½†æ˜¯è¿™ç§æ¨¡å¼çš„ç¼ºç‚¹ä¹Ÿæ˜¾è€Œæ˜“è§ï¼Œå°±æ˜¯ç±»çš„ä¸ªæ•°å®¹æ˜“è¿‡å¤šï¼Œå¢åŠ å¤æ‚åº¦ã€‚

ä¸Šé¢ä¾‹å­UMLå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![QQæˆªå›¾20191216105317.png](https://mrbird.cc/img/QQ%E6%88%AA%E5%9B%BE20191216105317.png)

### æŠ½è±¡å·¥å‚æ¨¡å¼

æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract factory patternï¼‰æä¾›äº†**ä¸€ç³»åˆ—**ç›¸å…³æˆ–è€…ç›¸äº’ä¾èµ–çš„å¯¹è±¡çš„æ¥å£ï¼Œå…³é”®å­—æ˜¯â€œä¸€ç³»åˆ—â€ã€‚

**ä¼˜ç‚¹**ï¼š

1. å…·ä½“äº§å“ä»å®¢æˆ·ç«¯ä»£ç ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œè§£è€¦ã€‚
2. å°†ä¸€ä¸ªç³»åˆ—çš„äº§å“æ—ç»Ÿä¸€åˆ°ä¸€èµ·åˆ›å»ºã€‚

**ç¼ºç‚¹**ï¼šæ‹“å±•æ–°çš„åŠŸèƒ½å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹æŠ½è±¡å·¥å‚çš„æ¥å£ï¼›

ç»¼ä¸Šæ‰€è¿°ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼é€‚åˆé‚£äº›åŠŸèƒ½ç›¸å¯¹å›ºå®šçš„äº§å“æ—çš„åˆ›å»ºã€‚

ä¸¾ä¾‹ï¼šæ–°å»ºæ°´æœæŠ½è±¡ç±»Fruitï¼ŒåŒ…å«buyæŠ½è±¡æ–¹æ³•ï¼š

```
public abstract class Fruit {

    public abstract void buy();
}
```



æ–°å»ºä»·æ ¼æŠ½è±¡ç±»Priceï¼ŒåŒ…å«payæŠ½è±¡æ–¹æ³•ï¼š

```
public abstract class Price {

    public abstract void pay();
}
```



æ–°å»ºæ°´æœåˆ›å»ºå·¥å‚æ¥å£FruitFactoryï¼ŒåŒ…å«è·å–æ°´æœå’Œä»·æ ¼æŠ½è±¡æ–¹æ³•ï¼ˆäº§å“æ—çš„ä½“ç°æ˜¯ï¼Œä¸€ç»„äº§å“åŒ…å«æ°´æœå’Œå¯¹åº”çš„ä»·æ ¼ï¼‰ï¼š

```
public interface FruitFactory {

    Fruit getFruit();
    Price getPrice();
}
```



æ¥ä¸‹æ¥å¼€å§‹åˆ›å»ºğŸè¿™ä¸ªâ€œäº§å“æ—â€ã€‚æ–°å»ºFruitå®ç°ç±»AppleFruitï¼š

```
public class AppleFruit extends Fruit{
    @Override
    public void buy() {
        System.out.println("è´­ä¹°ğŸ");
    }
}
```



æ–°å»ºå¯¹åº”çš„è‹¹æœä»·æ ¼å®ç°ApplePriceï¼š

```
public class ApplePrice extends Price{
    @Override
    public void pay() {
        System.out.println("ğŸå•ä»·2å…ƒ");
    }
}
```



åˆ›å»ºå®¢æˆ·ç«¯Applicationï¼Œæµ‹è¯•ä¸€æ³¢ï¼š

```
public class Application {
    public static void main(String[] args) {
        FruitFactory factory = new AppleFruitFactory();
        factory.getFruit().buy();
        factory.getPrice().pay();
    }
}
```



è¾“å‡ºå¦‚ä¸‹ï¼š

```
è´­ä¹°ğŸ
ğŸå•ä»·2å…ƒ
```



å®¢æˆ·ç«¯åªéœ€è¦é€šè¿‡åˆ›å»ºAppleFruitFactoryå°±å¯ä»¥è·å¾—è‹¹æœè¿™ä¸ªäº§å“æ—çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒ…æ‹¬è‹¹æœå¯¹è±¡ï¼Œè‹¹æœä»·æ ¼ã€‚è¦æ–°å»ºğŸŒçš„äº§å“æ—ï¼Œåªéœ€è¦å®ç°FruitFactoryã€Priceå’ŒFruitæ¥å£å³å¯ã€‚è¿™ç§æ¨¡å¼çš„ç¼ºç‚¹å’Œå·¥å‚æ–¹æ³•å·®ä¸å¤šï¼Œå°±æ˜¯ç±»çš„ä¸ªæ•°å®¹æ˜“è¿‡å¤šï¼Œå¢åŠ å¤æ‚åº¦ã€‚

ä¸Šé¢ä¾‹å­UMLå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![QQæˆªå›¾20191216112922.png](https://mrbird.cc/img/QQ%E6%88%AA%E5%9B%BE20191216112922.png)

### å»ºé€ è€…æ¨¡å¼

å»ºé€ è€…æ¨¡å¼ä¹Ÿç§°ä¸ºç”Ÿæˆå™¨æ¨¡å¼ï¼ˆBuilder Patternï¼‰ï¼Œå°†å¤æ‚å¯¹è±¡çš„å»ºé€ è¿‡ç¨‹æŠ½è±¡å‡ºæ¥ï¼ˆæŠ½è±¡ç±»åˆ«ï¼‰ï¼Œä½¿è¿™ä¸ªæŠ½è±¡è¿‡ç¨‹çš„ä¸åŒå®ç°æ–¹æ³•å¯ä»¥æ„é€ å‡ºä¸åŒè¡¨ç°ï¼ˆå±æ€§ï¼‰çš„å¯¹è±¡ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼Œç›¸åŒçš„è¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„äº§å“ã€‚

å°†å¤æ‚å¯¹è±¡çš„å»ºé€ è¿‡ç¨‹æŠ½è±¡å‡ºæ¥ï¼ˆæŠ½è±¡ç±»åˆ«ï¼‰ï¼Œä½¿è¿™ä¸ªæŠ½è±¡è¿‡ç¨‹çš„ä¸åŒå®ç°æ–¹æ³•å¯ä»¥æ„é€ å‡ºä¸åŒè¡¨ç°ï¼ˆå±æ€§ï¼‰çš„å¯¹è±¡ã€‚

ç®€å•æ¥è¯´å°±æ˜¯ï¼Œç›¸åŒçš„è¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„äº§å“ã€‚

é€‚ç”¨äºï¼š

1. ä¸€ä¸ªå¯¹è±¡æœ‰éå¸¸å¤æ‚çš„å†…éƒ¨ç»“æ„ï¼ˆå¾ˆå¤šå±æ€§ï¼‰
2. æƒ³å°†å¤æ‚å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨åˆ†ç¦»ã€‚

**ä¼˜ç‚¹**ï¼š

1. å°è£…æ€§å¥½ï¼Œåˆ›å»ºå’Œä½¿ç”¨åˆ†ç¦»
2. æ‹“å±•æ€§å¥½ï¼Œå»ºé€ ç±»ä¹‹é—´ç‹¬ç«‹ï¼Œä¸€å®šç¨‹åº¦ä¸Šè§£è€¦ã€‚

**ç¼ºç‚¹**ï¼š

1. äº§ç”Ÿå¤šä½™çš„Builderå¯¹è±¡ï¼›
2. äº§å“å†…éƒ¨å‘ç”Ÿå˜åŒ–ï¼Œå»ºé€ è€…éœ€è¦æ›´æ”¹ï¼Œæˆæœ¬è¾ƒå¤§ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

æ–°å¢å•†é“ºç±»Shopï¼ŒåŒ…å«åç§°ï¼Œåœ°ç‚¹å’Œç±»å‹å±æ€§ï¼š

```
public class Shop {

    private String name;
    private String location;
    private String type;

    @Override
    public String toString() {
        return "Shop{" +
                "name='" + name + '\'' +
                ", location='" + location + '\'' +
                ", type='" + type + '\'' +
                '}';
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getLocation() {
        return location;
    }

    public void setLocation(String location) {
        this.location = location;
    }

    public String getType() {
        return type;
    }

    public void setType(String type) {
        this.type = type;
    }
}
```



æ¥ç€åˆ›å»ºShopæŠ½è±¡ç”Ÿæˆå™¨ShopBuilderï¼š

```
public abstract class ShopBuilder {

    private String name;
    private String location;
    private String type;

    public abstract void name(String name);
    public abstract void location(String location);
    public abstract void type(String type);

    public abstract Shop build();
}
```



åŒ…å«å’ŒShopç›¸åŒçš„å±æ€§åŠå¯¹åº”çš„æŠ½è±¡æ„å»ºæ–¹æ³•ã€‚

ç»§ç»­åˆ›å»ºShopBuilderçš„å®ç°ï¼Œæ°´æœåº—æ„é€ å™¨FruitShopBuilderï¼š

```
public class FruitShopBuilder extends ShopBuilder{

    private Shop shop = new Shop();

    @Override
    public void name(String name) {
        this.shop.setName(name);
    }

    @Override
    public void location(String location) {
        this.shop.setLocation(location);
    }

    @Override
    public void type(String type) {
        this.shop.setType(type);
    }

    @Override
    public Shop build() {
        return shop;
    }
}
```



åˆ›å»ºä¸ªç»é”€å•†ç±»Dealerï¼Œç”¨äºé€šè¿‡ShopBuilderæ„å»ºå…·ä½“çš„å•†åº—ï¼š

```
public class Dealer {

    private ShopBuilder builder;

    public void setBuilder(ShopBuilder builder) {
        this.builder = builder;
    }

    public Shop build(String name, String location, String type) {
        this.builder.name(name);
        this.builder.location(location);
        this.builder.type(type);
        return builder.build();
    }
}
```



åˆ›å»ºä¸ªå®¢æˆ·ç«¯Applicationæµ‹è¯•ä¸€æ³¢ï¼š

```
public class Application {

    public static void main(String[] args) {
        ShopBuilder builder = new FruitShopBuilder();
        Dealer dealer = new Dealer();
        dealer.setBuilder(builder);

        Shop shop = dealer.build("XXæ°´æœåº—", "ç¦å·å¸‚XXåŒºXXè¡—XXå·", "æ°´æœç»è¥");
        System.out.println(shop);
    }
}
```



è¾“å‡ºå¦‚ä¸‹ï¼š

```
Shop{name='XXæ°´æœåº—', location='ç¦å·å¸‚XXåŒºXXè¡—XXå·', type='æ°´æœç»è¥'}
```



è¿™ä¸ªä¾‹å­æ˜¯å…¸å‹çš„å»ºé€ è€…æ¨¡å¼ï¼ŒUMLå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![QQæˆªå›¾20191216162813.png](https://mrbird.cc/img/QQ%E6%88%AA%E5%9B%BE20191216162813.png)

å…¶å®å»ºé€ è€…æ¨¡å¼æ›´ä¸ºå¸¸ç”¨çš„ä¾‹å­æ˜¯ä¸‹é¢è¿™ä¸ªï¼š

åˆ›å»ºä¸€ä¸ªåº—é“ºç±»Shopï¼ŒShopé‡ŒåŒ…å«æ„é€ è¯¥Shopçš„å†…éƒ¨ç±»ï¼š

```
public class Shop {

    private String name;
    private String location;
    private String type;

    public Shop(ShopBuilder builder) {
        this.name = builder.name;
        this.location = builder.location;
        this.type = builder.type;
    }

    @Override
    public String toString() {
        return "Shop{" +
                "name='" + name + '\'' +
                ", location='" + location + '\'' +
                ", type='" + type + '\'' +
                '}';
    }

    public static class ShopBuilder {
        private String name;
        private String location;
        private String type;

        public ShopBuilder name(String name) {
            this.name = name;
            return this;
        }

        public ShopBuilder location(String location) {
            this.location = location;
            return this;
        }

        public ShopBuilder type(String type) {
            this.type = type;
            return this;
        }

        public Shop build() {
            return new Shop(this);
        }
    }
}
```



åœ¨å®¢æˆ·ç«¯æ„å»ºShopåªéœ€ï¼š

```
public class Application {

    public static void main(String[] args) {
        Shop shop = new Shop.ShopBuilder()
                .name("XXæ°´æœåº—")
                .location("ç¦å·å¸‚XXåŒºXXè¡—XXå·")
                .type("æ°´æœç»è¥")
                .build();
        System.out.println(shop);
    }
}
```



è¿™ç§ç”¨æ³•å’ŒLombokçš„@Builderæ³¨è§£æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚

è¿™ä¸ªä¾‹å­çš„UMLå›¾ï¼š

![QQæˆªå›¾20191216163308.png](https://mrbird.cc/img/QQ%E6%88%AA%E5%9B%BE20191216163308.png)

### å•ä¾‹æ¨¡å¼

å•ä¾‹æ¨¡å¼ç›®çš„æ˜¯ä¸ºäº†ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚

ä¼˜ç‚¹ï¼š

1. å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜å¼€é”€ï¼›
2. å¯ä»¥é¿å…å¯¹èµ„æºçš„å¤šé‡å ç”¨ï¼›
3. è®¾ç½®å…¨å±€è®¿é—®ç‚¹ï¼Œä¸¥æ ¼æ§åˆ¶è®¿é—®ã€‚

ç¼ºç‚¹ï¼š

1. æ²¡æœ‰æ¥å£ï¼Œæ‹“å±•å›°éš¾ã€‚

#### æ‡’æ±‰æ¨¡å¼

æ‡’æ±‰æ¨¡å¼ä¸‹çš„å•ä¾‹å†™æ³•æ˜¯æœ€ç®€å•çš„ï¼Œä½†å®ƒæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼š

```
public class LazySingleton {

    private static LazySingleton lazySingleton = null;

    private LazySingleton() {

    }

    public static LazySingleton getInstance() {
        if (lazySingleton == null) {
            lazySingleton = new LazySingleton();
        }
        return lazySingleton;
    }
}
```



å¯åŠ åŒæ­¥é”è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š

```
public class LazySingleton {

    private static LazySingleton lazySingleton = null;

    private LazySingleton() {

    }

    public static LazySingleton getInstance() {
        synchronized (LazySingleton.class) {
            if (lazySingleton == null) {
                lazySingleton = new LazySingleton();
            }
        }
        return lazySingleton;
    }
}
```



ä½†æ˜¯åŒæ­¥é”é”çš„æ˜¯æ•´ä¸ªç±»ï¼Œæ¯”è¾ƒæ¶ˆè€—èµ„æºï¼Œå¹¶ä¸”å³ä½¿è¿è¡Œå†…å­˜ä¸­å·²ç»å­˜åœ¨LazySingletonï¼Œè°ƒç”¨å…¶getInstanceè¿˜æ˜¯ä¼šä¸Šé”ï¼Œæ‰€ä»¥è¿™ç§å†™æ³•ä¹Ÿä¸æ˜¯å¾ˆå¥½ã€‚

#### åŒé‡åŒæ­¥é”å•ä¾‹æ¨¡å¼

```
public class LazyDoubleCheckSingleton {

    private static LazyDoubleCheckSingleton instance = null;

    private LazyDoubleCheckSingleton() {

    }

    public static LazyDoubleCheckSingleton getInstance() {
        if (instance == null) {
            synchronized (LazyDoubleCheckSingleton.class) {
                if (instance == null) {
                    instance = new LazyDoubleCheckSingleton();
                }
            }
        }
        return instance;
    }
}
```

ä¸Šé¢ä¾‹å­è™½ç„¶åŠ äº†åŒæ­¥é”ï¼Œä½†å®ƒè¿˜æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚è™½ç„¶ä¸Šé¢çš„ä¾‹å­ä¸ä¼šå‡ºç°å¤šæ¬¡åˆå§‹åŒ–LazyDoubleCheckSingletonå®ä¾‹çš„æƒ…å†µï¼Œä½†æ˜¯ç”±äºæŒ‡ä»¤é‡æ’çš„åŸå› ï¼ŒæŸäº›çº¿ç¨‹å¯èƒ½ä¼šè·å–åˆ°ç©ºå¯¹è±¡ï¼Œåç»­å¯¹è¯¥å¯¹è±¡çš„æ“ä½œå°†è§¦å‘ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚

è¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œåªéœ€è¦é˜»æ­¢æŒ‡ä»¤é‡æ’å³å¯ï¼Œæ‰€ä»¥å¯ä»¥ç»™instanceå±æ€§åŠ ä¸Švolatileå…³é”®å­—ï¼š

```
public class LazyDoubleCheckSingleton {

    private volatile static LazyDoubleCheckSingleton instance = null;

    private LazyDoubleCheckSingleton() {

    }

    public static LazyDoubleCheckSingleton getInstance() {
        if (instance == null) {
            synchronized (LazyDoubleCheckSingleton.class) {
                if (instance == null) {
                    instance = new LazyDoubleCheckSingleton();
                }
            }
        }
        return instance;
    }
}
```



ç›¸å…³åšæ–‡ï¼š[æ·±å…¥ç†è§£volatileå…³é”®å­—](https://mrbird.cc/volatile.html)ã€‚

ä¸Šé¢è¿™ç§å†™æ³•æ˜¯ä¸ä½†ç¡®ä¿äº†çº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸”å½“LazyDoubleCheckSingletonå®ä¾‹åˆ›å»ºå¥½åï¼Œåç»­å†è°ƒç”¨å…¶getInstanceæ–¹æ³•ä¸ä¼šä¸Šé”ã€‚

#### é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼

çœ‹ä¾‹å­ï¼š

```
public class StaticInnerClassSingleton {

    private StaticInnerClassSingleton() {

    }

    private static class InnerClass {
        private static StaticInnerClassSingleton instance = new StaticInnerClassSingleton();
    }

    public static StaticInnerClassSingleton getInstance() {
        return InnerClass.instance;
    }
}
```



ä¸ºä»€ä¹ˆè¿™ä¸ªä¾‹å­æ˜¯å¯è¡Œçš„å‘¢ï¼Ÿä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š

1. JVMåœ¨ç±»çš„åˆå§‹åŒ–é˜¶æ®µä¼šåŠ Classå¯¹è±¡åˆå§‹åŒ–åŒæ­¥é”ï¼ŒåŒæ­¥å¤šä¸ªçº¿ç¨‹å¯¹è¯¥ç±»çš„åˆå§‹åŒ–æ“ä½œï¼›
2. é™æ€å†…éƒ¨ç±»InnerClassçš„é™æ€æˆå‘˜å˜é‡instanceåœ¨æ–¹æ³•åŒºä¸­åªä¼šæœ‰ä¸€ä¸ªå®ä¾‹ã€‚

åœ¨Javaè§„èŒƒä¸­ï¼Œå½“ä»¥ä¸‹è¿™äº›æƒ…å†µé¦–æ¬¡å‘ç”Ÿæ—¶ï¼ŒAç±»å°†ä¼šç«‹åˆ»è¢«åˆå§‹åŒ–ï¼š

1. Aç±»å‹å®ä¾‹è¢«åˆ›å»ºï¼›
2. Aç±»ä¸­å£°æ˜çš„é™æ€æ–¹æ³•è¢«è°ƒç”¨ï¼›
3. Aç±»ä¸­çš„é™æ€æˆå‘˜å˜é‡è¢«èµ‹å€¼ï¼›
4. Aç±»ä¸­çš„é™æ€æˆå‘˜è¢«ä½¿ç”¨ï¼ˆéå¸¸é‡ï¼‰ï¼›

#### é¥¿æ±‰å•ä¾‹æ¨¡å¼

â€œé¥¿æ±‰â€æ„æŒ‡åœ¨ç±»åŠ è½½çš„æ—¶å€™å°±åˆå§‹åŒ–ï¼š

```
public class HungrySingleton {

    private final static HungrySingleton instance = new HungrySingleton();

    private HungrySingleton() {

    }

    public static HungrySingleton getInstance() {
        return instance;
    }
}
```



è¿™ç§æ¨¡å¼åœ¨ç±»åŠ è½½çš„æ—¶å€™å°±å®Œæˆäº†åˆå§‹åŒ–ï¼Œæ‰€ä»¥å¹¶ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨æ€§é—®é¢˜ï¼›ä½†ç”±äºä¸æ˜¯æ‡’åŠ è½½ï¼Œé¥¿æ±‰æ¨¡å¼ä¸ç®¡éœ€ä¸éœ€è¦ç”¨åˆ°å®ä¾‹éƒ½è¦å»åˆ›å»ºå®ä¾‹ï¼Œå¦‚æœåˆ›å»ºäº†ä¸ä½¿ç”¨ï¼Œåˆ™ä¼šé€ æˆå†…å­˜æµªè´¹ã€‚

#### åºåˆ—åŒ–ç ´åå•ä¾‹æ¨¡å¼

å‰é¢çš„å•ä¾‹ä¾‹å­åœ¨å®ç°åºåˆ—åŒ–æ¥å£åéƒ½èƒ½è¢«åºåˆ—åŒ–çš„æ–¹å¼ç ´åï¼Œæ¯”å¦‚HungrySingletonï¼Œè®©å…¶å®ç°åºåˆ—åŒ–æ¥å£ï¼š

```
public class HungrySingleton implements Serializable {

    private static final long serialVersionUID = -8073288969651806838L;

    private final static HungrySingleton instance = new HungrySingleton();

    private HungrySingleton() {

    }

    public static HungrySingleton getInstance() {
        return instance;
    }
}
```



ç„¶ååˆ›å»ºApplicationæµ‹è¯•ä¸€ä¸‹å¦‚ä½•ç ´åï¼š

```
public class Application {

    public static void main(String[] args) throws IOException, ClassNotFoundException {
        // æ¼”ç¤ºåºåˆ—åŒ–ç ´åå•ä¾‹
        HungrySingleton instance = HungrySingleton.getInstance();
        ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream("file"));
        outputStream.writeObject(instance);

        ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream("file"));
        HungrySingleton newInstance = (HungrySingleton) inputStream.readObject();

        System.out.println(instance);
        System.out.println(newInstance);
        System.out.println(instance == newInstance);
    }
}
```



è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š

```
cc.mrbird.design.pattern.creational.singleton.HungrySingleton@7f31245a
cc.mrbird.design.pattern.creational.singleton.HungrySingleton@6d03e736
false
```



å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶æ˜¯å•ä¾‹æ¨¡å¼ï¼Œä½†å´æˆåŠŸåˆ›å»ºå‡ºäº†ä¸¤ä¸ªä¸ä¸€æ ·çš„å®ä¾‹ï¼Œå•ä¾‹é­åˆ°äº†ç ´åã€‚

è¦è®©ååºåˆ—åŒ–åçš„å¯¹è±¡å’Œåºåˆ—åŒ–å‰çš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„è¯ï¼Œå¯ä»¥åœ¨HungrySingletoné‡ŒåŠ ä¸ŠreadResolveæ–¹æ³•ï¼š

```
public class HungrySingleton implements Serializable {

    private static final long serialVersionUID = -8073288969651806838L;

    private final static HungrySingleton instance = new HungrySingleton();

    private HungrySingleton() {

    }

    public static HungrySingleton getInstance() {
        return instance;
    }
    // æ–°å¢
    private Object readResolve() {
        return instance;
    }
}
```



å†æ¬¡è¿è¡ŒApplicationçš„mainæ–¹æ³•åï¼š

```
cc.mrbird.design.pattern.creational.singleton.HungrySingleton@7f31245a
cc.mrbird.design.pattern.creational.singleton.HungrySingleton@7f31245a
true
```



å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ–¹å¼æœ€ç»ˆååºåˆ—åŒ–å‡ºæ¥çš„å¯¹è±¡å’Œåºåˆ—åŒ–å¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚ä½†è¿™ç§æ–¹å¼ååºåˆ—åŒ–è¿‡ç¨‹å†…éƒ¨è¿˜æ˜¯ä¼šé‡æ–°åˆ›å»ºHungrySingletonå®ä¾‹ï¼Œåªä¸è¿‡å› ä¸ºHungrySingletonç±»å®šä¹‰äº†readResolveæ–¹æ³•ï¼ˆæ–¹æ³•å†…éƒ¨è¿”å›instanceå¼•ç”¨ï¼‰ï¼Œååºåˆ—åŒ–è¿‡ç¨‹ä¼šåˆ¤æ–­ç›®æ ‡ç±»æ˜¯å¦å®šä¹‰äº†readResolveè¯¥æ–¹æ³•ï¼Œæ˜¯çš„è¯åˆ™é€šè¿‡åå°„è°ƒç”¨è¯¥æ–¹æ³•ã€‚

#### åå°„ç ´åå•ä¾‹æ¨¡å¼

é™¤äº†åºåˆ—åŒ–èƒ½ç ´åå•ä¾‹å¤–ï¼Œåå°„ä¹Ÿå¯ä»¥ï¼Œä¸¾ä¸ªåå°„ç ´åHungrySingletonçš„ä¾‹å­ï¼š

```
public class Application {

    public static void main(String[] args) throws Exception {
        HungrySingleton instance = HungrySingleton.getInstance();
        // åå°„åˆ›å»ºå®ä¾‹
        Class<HungrySingleton> c = HungrySingleton.class;
        // è·å–æ„é€ å™¨
        Constructor<HungrySingleton> constructor = c.getDeclaredConstructor();
        // æ‰“å¼€æ„é€ å™¨æƒé™
        constructor.setAccessible(true);
        HungrySingleton newInstance = constructor.newInstance();

        System.out.println(instance);
        System.out.println(newInstance);
        System.out.println(instance == newInstance);
    }
}
```



è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š

```
cc.mrbird.design.pattern.creational.singleton.HungrySingleton@1b6d3586
cc.mrbird.design.pattern.creational.singleton.HungrySingleton@4554617c
false
```



å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é€šè¿‡åå°„ç ´åäº†ç§æœ‰æ„é€ å™¨æƒé™ï¼ŒæˆåŠŸåˆ›å»ºäº†æ–°çš„å®ä¾‹ã€‚

å¯¹äºè¿™ç§æƒ…å†µï¼Œé¥¿æ±‰æ¨¡å¼ä¸‹çš„ä¾‹å­å¯ä»¥åœ¨æ„é€ å™¨ä¸­æ·»åŠ åˆ¤æ–­é€»è¾‘æ¥é˜²å¾¡ï¼ˆæ‡’æ±‰æ¨¡å¼çš„å°±æ²¡æœ‰åŠæ³•äº†ï¼‰ï¼Œæ¯”å¦‚ä¿®æ”¹HungrySingletonçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```
public class HungrySingleton {

    private final static HungrySingleton instance = new HungrySingleton();

    private HungrySingleton() {
        if (instance != null) {
            throw new RuntimeException("forbidden");
        }
    }

    public static HungrySingleton getInstance() {
        return instance;
    }
}
```



å†æ¬¡è¿è¡ŒApplicationçš„mainæ–¹æ³•ï¼š

```
Exception in thread "main" java.lang.reflect.InvocationTargetException
    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
    at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
    at cc.mrbird.design.pattern.creational.singleton.Application.main(Application.java:33)
Caused by: java.lang.RuntimeException: forbidden
    at cc.mrbird.design.pattern.creational.singleton.HungrySingleton.<init>(HungrySingleton.java:16)
    ... 5 more
```



#### æšä¸¾å•ä¾‹æ¨¡å¼

æšä¸¾å•ä¾‹æ¨¡å¼æ˜¯æ¨èçš„å•ä¾‹æ¨¡å¼ï¼Œå®ƒä¸ä»…å¯ä»¥é˜²å¾¡åºåˆ—åŒ–æ”»å‡»ï¼Œä¹Ÿå¯ä»¥é˜²å¾¡åå°„æ”»å‡»ã€‚ä¸¾ä¸ªæšä¸¾å•ä¾‹æ¨¡å¼çš„ä»£ç ï¼š

```
public enum EnumSingleton {

    INSTANCE;

    private Object data;

    public Object getData() {
        return data;
    }

    public void setData(Object data) {
        this.data = data;
    }

    public static EnumSingleton getInstance(){
        return INSTANCE;
    }
}
```



éªŒè¯ä¸‹æ˜¯å¦æ˜¯å•ä¾‹çš„ï¼š

```
public class Application {

    public static void main(String[] args) throws Exception {

        EnumSingleton instance = EnumSingleton.getInstance();
        instance.setData(new Object());
        EnumSingleton newInstance = EnumSingleton.getInstance();

        System.out.println(instance);
        System.out.println(newInstance);
        System.out.println(instance.getData());
        System.out.println(newInstance.getData());
    }
}
```



è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š

```
INSTANCE
INSTANCE
java.lang.Object@1b6d3586
java.lang.Object@1b6d3586
```



æµ‹è¯•ä¸‹åºåˆ—åŒ–æ”»å‡»ï¼š

```
public class Application {

    public static void main(String[] args) throws Exception {
        EnumSingleton instance = EnumSingleton.getInstance();
        instance.setData(new Object());
        ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream("file"));
        outputStream.writeObject(instance);
       
        ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream("file"));
        EnumSingleton newInstance = (EnumSingleton) inputStream.readObject();

        System.out.println(instance);
        System.out.println(newInstance);
        System.out.println(instance == newInstance);

        System.out.println(instance.getData());
        System.out.println(newInstance.getData());
        System.out.println(instance.getData() == newInstance.getData());
    }
}
```



è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š

```
INSTANCE
INSTANCE
true
java.lang.Object@568db2f2
java.lang.Object@568db2f2
true
```



å¯ä»¥çœ‹åˆ°åºåˆ—åŒ–å’Œååºåˆ—åŒ–åçš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªã€‚

åŸç†ï¼šè·Ÿè¸ªObjectInputStream#readObjectæºç ï¼Œå…¶ä¸­å½“åç¼–è¯‘å¯¹è±¡ä¸ºæšä¸¾ç±»å‹æ—¶ï¼Œå°†è°ƒç”¨readEnumæ–¹æ³•ï¼š

![QQæˆªå›¾20191217155448.png](https://mrbird.cc/img/QQ%E6%88%AA%E5%9B%BE20191217155448.png)

nameä¸ºæšä¸¾ç±»é‡Œçš„æšä¸¾å¸¸é‡ï¼Œå¯¹äºçº¿ç¨‹æ¥è¯´å®ƒæ˜¯å”¯ä¸€çš„ï¼Œå­˜åœ¨æ–¹æ³•åŒºï¼Œæ‰€ä»¥é€šè¿‡`Enum.valueOf((Class)cl, name)`æ–¹æ³•å¾—åˆ°çš„æšä¸¾å¯¹è±¡éƒ½æ˜¯åŒä¸€ä¸ªã€‚

å†æµ‹è¯•ä¸€ä¸‹åå°„æ”»å‡»ï¼š

```
public class Application {

    public static void main(String[] args) throws Exception {
        EnumSingleton instance = EnumSingleton.getInstance();

        Class<EnumSingleton> c = EnumSingleton.class;
        // æšä¸¾ç±»åªåŒ…å«ä¸€ä¸ª(String,int)ç±»å‹æ„é€ å™¨
        Constructor<EnumSingleton> constructor = c.getDeclaredConstructor(String.class, int.class);
        constructor.setAccessible(true);
        EnumSingleton newInstance = constructor.newInstance("hello", 1);

        System.out.println(instance == newInstance);
    }
}
```



è¿è¡Œè¾“å‡ºå¦‚ä¸‹ï¼š

```
Exception in thread "main" java.lang.IllegalArgumentException: Cannot reflectively create enum objects
    at java.lang.reflect.Constructor.newInstance(Constructor.java:417)
    at cc.mrbird.design.pattern.creational.singleton.Application.main(Application.java:71)
```



å¯ä»¥çœ‹åˆ°æŠ›å¼‚å¸¸äº†ï¼ŒæŸ¥çœ‹Constructorç±»çš„417è¡Œä»£ç å¯ä»¥å‘ç°åŸå› ï¼š![QQæˆªå›¾20191217160647.png](https://mrbird.cc/img/QQ%E6%88%AA%E5%9B%BE20191217160647.png)

Javaç¦æ­¢é€šè¿‡åå°„åˆ›å»ºæšä¸¾å¯¹è±¡ã€‚

æ­£æ˜¯å› ä¸ºæšä¸¾ç±»å‹æ‹¥æœ‰è¿™äº›å¤©ç„¶çš„ä¼˜åŠ¿ï¼Œæ‰€ä»¥ç”¨å®ƒåˆ›å»ºå•ä¾‹æ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œè¿™ä¹Ÿæ˜¯Effective Javaæ¨èçš„æ–¹å¼ã€‚

### åŸå‹æ¨¡å¼

åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»ï¼Œé€šè¿‡æ‹·è´è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚

é€‚ç”¨äºï¼š

1. ç±»åˆå§‹åŒ–æ¶ˆè€—è¾ƒå¤šèµ„æºï¼›
2. å¾ªç¯ä½“ä¸­ç”Ÿäº§å¤§é‡å¯¹è±¡çš„æ—¶å€™ã€‚

ä¼˜ç‚¹ï¼š

1. åŸå‹æ¨¡å¼æ€§èƒ½æ¯”ç›´æ¥newä¸€ä¸ªå¯¹è±¡æ€§èƒ½å¥½ï¼›
2. ç®€åŒ–åˆ›å»ºå¯¹è±¡è¿‡ç¨‹ã€‚

ç¼ºç‚¹ï¼š

1. å¯¹è±¡å¿…é¡»é‡å†™Objectå…‹éš†æ–¹æ³•ï¼›
2. å¤æ‚å¯¹è±¡çš„å…‹éš†æ–¹æ³•å†™èµ·æ¥è¾ƒéº»çƒ¦ï¼ˆæ·±å…‹éš†ã€æµ…å…‹éš†ï¼‰

ä¸¾ä¾‹ï¼šæ–°å»ºä¸€ä¸ªå­¦ç”Ÿç±»Studentï¼Œå®ç°å…‹éš†æ¥å£ï¼Œå¹¶é‡å†™Objectçš„å…‹éš†æ–¹æ³•ï¼ˆå› ä¸ºéƒ½æ˜¯ç®€å•å±æ€§ï¼Œæ‰€ä»¥æµ…å…‹éš†å³å¯ï¼‰ï¼š

```
public class Student implements Cloneable {

    private String name;
    private int age;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    @Override
    public String toString() {
        return "Student{" +
                "name='" + name + '\'' +
                ", age=" + age +
                '}';
    }

    @Override
    protected Object clone() throws CloneNotSupportedException {
        return super.clone();
    }
}
```



åœ¨Applicationä¸­æµ‹è¯•ä¸€æ³¢ï¼š

```
public class Application {

    public static void main(String[] args) throws CloneNotSupportedException {
        Student student = new Student();
        ArrayList<Student> list = new ArrayList<>();
        for (int i = 0; i < 3; i++) {
            Student s = (Student) student.clone();
            s.setName("å­¦ç”Ÿ" + i);
            s.setAge(20 + i);
            list.add(s);
        }
        System.out.println(list);
    }
}
```



è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š

```
[Student{name='å­¦ç”Ÿ0', age=20}, Student{name='å­¦ç”Ÿ1', age=21}, Student{name='å­¦ç”Ÿ2', age=22}]
```



è¿™ç§æ–¹å¼ä¼šæ¯”ç›´æ¥åœ¨å¾ªç¯ä¸­åˆ›å»ºStudentæ€§èƒ½å¥½ã€‚

å½“å¯¹è±¡åŒ…å«å¼•ç”¨ç±»å‹å±æ€§æ—¶ï¼Œéœ€è¦ä½¿ç”¨æ·±å…‹éš†ï¼Œæ¯”å¦‚StudentåŒ…å«Dateå±æ€§æ—¶ï¼š

```
public class Student implements Cloneable {

    private String name;
    private int age;
    private Date birthday;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    public Date getBirthday() {
        return birthday;
    }

    public void setBirthday(Date birthday) {
        this.birthday = birthday;
    }

    @Override
    public String toString() {
        return "Student{" +
                "name='" + name + '\'' +
                ", age=" + age +
                ", birthday=" + birthday +
                '}';
    }

    @Override
    protected Object clone() throws CloneNotSupportedException {
        Student student = (Student) super.clone();
        // å¼•ç”¨ç±»å‹æ·±å…‹éš†
        Date birthday = (Date) student.getBirthday().clone();
        student.setBirthday(birthday);
        return student;
    }
}
```



å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå…‹éš†ä¼šç ´åå®ç°äº†Cloneableæ¥å£çš„å•ä¾‹å¯¹è±¡ã€‚
